{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adopt a Pet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'accounts/main.css' %}">

  <style>
    body {
      background: #ffffff;
      font-family: 'Poppins', sans-serif;
    }
    .pet-card-modern {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
      border: 1px solid #f1f5f9;
      margin-bottom: 30px;
    }
    .pet-card-modern:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
    }
    .pet-img-container {
      background: #f8fafc;
      padding: 30px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
    }
    .pet-img-container img {
      width: 100%;
      max-width: 280px;
      height: 280px;
      object-fit: cover;
      border-radius: 12px;
    }
    .btn-adopt-modern {
      background: #20c997;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-block;
      border: none;
    }
    .btn-adopt-modern:hover {
      background: #17a589;
      color: white;
      transform: translateY(-2px);
    }
    .btn-sponsor-modern {
      background: #f1f5f9;
      color: #64748b;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-block;
      border: none;
    }
    .btn-sponsor-modern:hover {
      background: #e2e8f0;
      color: #64748b;
    }
  </style>
</head>
<body>
    <!-- Modern Navbar -->
    <nav class="navbar-modern">
      <div class="container">
        <a href="/" class="navbar-brand-modern">
          <i class="fa-solid fa-paw"></i>
          <span>PawConnect</span>
        </a>
        <ul class="navbar-nav-modern">
          <li><a href="/" class="nav-link-modern">HOME</a></li>
          <li><a href="{% url 'adoption_section' %}" class="nav-link-modern active">ADOPT</a></li>
          <li><a href="/#sos" class="nav-link-modern">RESCUE</a></li>
          <li><a href="{% url 'volunteer_apply' %}" class="nav-link-modern">VOLUNTEER</a></li>
          <li><a href="{% url 'donate' %}" class="nav-link-modern">DONATE</a></li>
        </ul>
        <div class="navbar-actions">
          {% if user.is_authenticated %}
            <a href="{% url 'profile' %}" class="icon-btn"><i class="fa-solid fa-user"></i></a>
            <a href="{% url 'logout' %}" class="btn-donate">Logout</a>
          {% else %}
            <a href="{% url 'login' %}" class="icon-btn"><i class="fa-solid fa-user"></i></a>
            <a href="{% url 'signup' %}" class="btn-donate">Sign Up</a>
          {% endif %}
        </div>
      </div>
    </nav>

    
  <div class="container" style="padding: 80px 20px;">
    <div class="text-center mb-5">
      <p style="color: #94a3b8; font-size: 0.95rem; margin-bottom: 12px; letter-spacing: 1px;">Meet the animals</p>
      <h1 style="font-size: 2.5rem; font-weight: 700; color: #1a374d; margin-bottom: 15px; font-family: 'Fredoka One', cursive;">Puppies Waiting for Adoption</h1>
      <p style="color: #64748b; font-size: 1rem; max-width: 700px; margin: 0 auto;">Each of these rescued animals has been vaccinated, microchipped, and is ready to join a loving family.</p>
    </div>
    
    <div class="row g-4" style="margin-top: 50px;">
      {% for pet in pets %}
      <div class="col-md-4">
        <div class="pet-card-modern">
          <div class="pet-img-container">
            <img src="{{ pet.image }}" alt="{{ pet.name }}">
          </div>
          <div style="padding: 25px;">
            <h5 style="font-size: 1.1rem; font-weight: 500; color: #1e293b; margin-bottom: 12px; line-height: 1.5;">
              <span style="font-weight: 600;">PET{{ pet.id|stringformat:"03d" }}</span> <span style="color: #64748b; font-weight: 400;">-</span> {{ pet.name }}
            </h5>
            <p style="color: #64748b; font-size: 0.95rem; margin-bottom: 15px;">
              <span style="margin-right: 15px;">Genre: {{ pet.gender }}</span> ‚Ä¢ 
              <span style="margin-left: 5px;">Age: {{ pet.age }}</span>
            </p>
            <div style="border-top: 1px solid #f1f5f9; padding-top: 18px; margin-top: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <p style="font-size: 1.15rem; font-weight: 700; color: #1a374d; margin: 0;">Free Adoption</p>
                <div style="display: flex; gap: 6px; font-size: 0.85rem; color: #64748b;">
                  <span title="Vaccinated"><i class="fa-solid fa-shield-virus" style="color: {% if pet.vaccinated %}#20c997{% else %}#e2e8f0{% endif %};"></i></span>
                  <span title="Neutered/Spayed"><i class="fa-solid fa-check-circle" style="color: {% if pet.neutered_spayed %}#20c997{% else %}#e2e8f0{% endif %};"></i></span>
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <a href="{% url 'adopt_pet' pet.id %}" class="btn-adopt-modern" style="flex: 1; text-align: center;"><i class="fa-solid fa-heart"></i> Adopt</a>
                <a href="{% url 'sponsor_pet' pet.id %}" class="btn-sponsor-modern" style="flex: 1; text-align: center;"><i class="fa-regular fa-star"></i> Sponsor</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

 <!-- Chatbox Toggle Button -->
<div id="chat-toggle" class="chat-toggle" style="position:fixed!important;bottom:30px!important;right:30px!important;width:60px!important;height:60px!important;min-width:60px!important;max-width:60px!important;z-index:99999!important;border-radius:12px!important;background:linear-gradient(135deg,#20c997,#17a589)!important;display:flex!important;align-items:center!important;justify-content:center!important;cursor:pointer!important;color:#fff!important;font-size:1.4rem!important;left:auto!important;top:auto!important;margin:0!important;padding:0!important;">
  <i class="fa-solid fa-comments"></i>
</div>

<!-- Chat Window -->
<div id="chat-container" class="chat-container hidden" style="position:fixed!important;bottom:100px!important;right:30px!important;width:360px!important;max-width:360px!important;min-width:360px!important;height:480px!important;z-index:9998!important;border-radius:16px!important;background:#fff!important;box-shadow:0 12px 40px rgba(0,0,0,0.15)!important;display:flex!important;flex-direction:column!important;overflow:hidden!important;border:1px solid #e2e8f0!important;left:auto!important;top:auto!important;margin:0!important;padding:0!important;">
    <!-- Header -->
    <div class="chat-header">
        <span><i class="fa-solid fa-robot"></i> PAW AI Assistant</span>
        <i class="fa-solid fa-times" style="cursor: pointer; font-size: 1.2rem;" onclick="document.getElementById('chat-container').classList.add('hidden')"></i>
    </div>

  <!-- Messages -->
  <div id="chat-box" class="chat-box">
    How can we help you?
  </div>

  <!-- Input Area -->
  <form id="chatForm" class="input-container">
    <input type="text" id="user-input" placeholder="Type your message...">
    <button type="submit" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
  </form>
</div>

  <script>
const API_URL = "http://127.0.0.1:8001/chat/";
let conversationId = localStorage.getItem("conversationId") || "convo-" + Date.now();
localStorage.setItem("conversationId", conversationId);

// Load chat history on page load
window.addEventListener("DOMContentLoaded", () => {
  loadChatHistory();
});

// Save message to localStorage
function saveChatMessage(sender, text) {
  const chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  chatHistory.push({ sender, text, timestamp: Date.now() });
  if (chatHistory.length > 50) {
    chatHistory.shift();
  }
  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
}

// Load chat history from localStorage
function loadChatHistory() {
  const chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  const chatBox = document.getElementById("chat-box");
  
  if (chatHistory.length > 0) {
    chatBox.innerHTML = "";
  }
  
  chatHistory.forEach(msg => {
    appendMessage(msg.sender, msg.text, false);
  });
  
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Clear chat history
function clearChatHistory() {
  localStorage.removeItem("chatHistory");
  localStorage.removeItem("conversationId");
  conversationId = "convo-" + Date.now();
  localStorage.setItem("conversationId", conversationId);
  const chatBox = document.getElementById("chat-box");
  chatBox.innerHTML = '<div class="message bot">üëã Hello! I\'m PAW AI Assistant. How can I help you today?</div>';
}

// Toggle chat window
const chatToggle = document.getElementById("chat-toggle");
const chatContainer = document.getElementById("chat-container");

chatToggle.addEventListener("click", (e) => {
  e.stopPropagation();
  chatContainer.classList.toggle("hidden");
});

// Close and clear buttons
setTimeout(() => {
  const closeBtn = document.getElementById("close-chat-btn");
  const clearBtn = document.getElementById("clear-chat-btn");
  
  if (closeBtn) {
    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      e.preventDefault();
      chatContainer.classList.add("hidden");
    });
    
    closeBtn.addEventListener("mouseenter", () => {
      closeBtn.style.transform = "rotate(90deg)";
    });
    
    closeBtn.addEventListener("mouseleave", () => {
      closeBtn.style.transform = "rotate(0deg)";
    });
  }
  
  if (clearBtn) {
    clearBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      e.preventDefault();
      if (confirm("Are you sure you want to clear the chat history?")) {
        clearChatHistory();
      }
    });
    
    clearBtn.addEventListener("mouseenter", () => {
      clearBtn.style.transform = "scale(1.1)";
      clearBtn.style.color = "#ef4444";
    });
    
    clearBtn.addEventListener("mouseleave", () => {
      clearBtn.style.transform = "scale(1)";
      clearBtn.style.color = "#fff";
    });
  }
}, 100);

// Send button click
document.getElementById("send-btn").addEventListener("click", function(e) {
  e.preventDefault();
  sendMessage();
});

// Form submit
document.getElementById("chatForm").addEventListener("submit", function(e) {
  e.preventDefault();
  sendMessage();
});

// Enter key press
document.getElementById("user-input").addEventListener("keypress", function (event) {
  if (event.key === "Enter") {
    event.preventDefault();
    sendMessage();
  }
});

async function sendMessage() {
  const input = document.getElementById("user-input");
  const userMessage = input.value.trim();
  if (!userMessage) return;

  appendMessage("user", userMessage);
  input.value = "";
  
  // Show typing indicator
  const typingIndicator = showTypingIndicator();

  try {
    const response = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: userMessage,
        role: "user",
        conversation_id: conversationId
      })
    });

    const data = await response.json();
    
    // Remove typing indicator
    removeTypingIndicator(typingIndicator);
    
    if (response.ok) {
      appendMessage("bot", data.response);
    } else {
      appendMessage("bot", "‚ö†Ô∏è Error: " + data.detail);
    }
  } catch (error) {
    removeTypingIndicator(typingIndicator);
    appendMessage("bot", "‚ö†Ô∏è Server not reachable!");
  }
}

function showTypingIndicator() {
    const chatBox = document.getElementById("chat-box");
    const typingDiv = document.createElement("div");
    typingDiv.className = "typing-indicator";
    typingDiv.id = "typing-indicator";
    typingDiv.innerHTML = "<span></span><span></span><span></span>";
    chatBox.appendChild(typingDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    return typingDiv;
}

function removeTypingIndicator(indicator) {
    if (indicator && indicator.parentNode) {
        indicator.parentNode.removeChild(indicator);
    }
}

// Format bot response with markdown-like support
function formatBotResponse(text) {
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
    text = text.replace(/^[-‚Ä¢]\s+(.+)$/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>\s*)+/gs, '<ul>$&</ul>');
    text = text.replace(/\n(?![^<]*<\/ul>)/g, '<br>');
    return text;
}

// Typing animation for bot messages
async function typeMessage(element, text, speed = 30) {
    const formattedText = formatBotResponse(text);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = formattedText;
    
    if (formattedText === text) {
        for (let i = 0; i < text.length; i++) {
            element.textContent += text[i];
            const chatBox = document.getElementById("chat-box");
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (['.', '!', '?'].includes(text[i])) {
                await new Promise(resolve => setTimeout(resolve, 300));
            } else if ([',', ';', ':'].includes(text[i])) {
                await new Promise(resolve => setTimeout(resolve, 150));
            } else {
                await new Promise(resolve => setTimeout(resolve, speed));
            }
        }
    } else {
        await new Promise(resolve => setTimeout(resolve, 500));
        element.innerHTML = formattedText;
    }
    
    const chatBox = document.getElementById("chat-box");
    chatBox.scrollTop = chatBox.scrollHeight;
}

function appendMessage(sender, text, animated = true) {
    const chatBox = document.getElementById("chat-box");
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${sender}`;
    
    if (sender === "user") {
        messageDiv.textContent = text;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        saveChatMessage(sender, text);
    } else {
        chatBox.appendChild(messageDiv);
        
        if (animated) {
            typeMessage(messageDiv, text).then(() => {
                saveChatMessage(sender, text);
            });
        } else {
            const formattedText = formatBotResponse(text);
            if (formattedText !== text) {
                messageDiv.innerHTML = formattedText;
            } else {
                messageDiv.textContent = text;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }
}
  </script><!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
